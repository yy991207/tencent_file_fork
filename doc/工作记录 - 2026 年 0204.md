# 工作记录 - 2026 年 0204

## 改动背景

用户需要为文件树组件设计并实现完整的拖拽视觉反馈系统，具体需求如下：

1. **拖拽场景一（放入文件夹）**：当拖拽文件或文件夹悬停在目标文件夹上方时，目标文件夹应显示蓝色边框或背景高亮效果
2. **拖拽场景二（插入排序）**：当拖拽到另一个文件或文件夹的上方/下方边缘时，应在对应位置显示一条蓝色水平指示线
3. **视觉反馈触发机制**：需要精确计算鼠标位置与目标元素的相对关系来判断触发哪种效果
4. **效果互斥**：两种视觉效果不可同时出现

## 主要修改点

### 1. FileList 组件重构 (`src/components/FileList/index.tsx`)

**改动内容：**
- 从基于 Ant Design Table 的实现改为自定义的可拖拽列表
- 添加完整的拖拽状态管理（`DragState` 接口）
- 实现精确的位置检测逻辑（`calculateDropPosition` 函数）
- 添加拖拽事件处理器（`onDragStart`、`onDragOver`、`onDragLeave`、`onDrop`、`onDragEnd`）
- 实现视觉反馈渲染逻辑

**核心逻辑说明：**

```typescript
// 拖拽放置位置类型
type DropPosition = 'inside' | 'before' | 'after' | null;

// 边缘检测阈值（8像素）
const EDGE_THRESHOLD = 8;

// 位置计算逻辑
const calculateDropPosition = (event, targetItem): DropPosition => {
  const rect = event.currentTarget.getBoundingClientRect();
  const relativeY = event.clientY - rect.top;
  const height = rect.height;

  // 上边缘区域 -> 'before'
  if (relativeY < EDGE_THRESHOLD) return 'before';
  // 下边缘区域 -> 'after'  
  if (relativeY > height - EDGE_THRESHOLD) return 'after';
  // 中间区域 + 目标是文件夹 -> 'inside'
  if (targetItem.type === FileType.FOLDER) return 'inside';
  // 非文件夹按距离判断
  return relativeY < height / 2 ? 'before' : 'after';
};
```

### 2. FileList 样式更新 (`src/components/FileList/index.module.less`)

**添加的样式：**

1. **放入文件夹效果（`.dropInside`）**
   - 蓝色边框（`border: 2px solid #1890ff`）
   - 浅蓝色背景（`background-color: #e6f7ff`）
   - 外发光效果（`box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2)`）

2. **插入指示线（`.dropIndicator`）**
   - 蓝色圆点（`.dropIndicatorDot`）
   - 蓝色水平线（`.dropIndicatorLine`）
   - 位置区分（`.dropIndicatorBefore` / `.dropIndicatorAfter`）

3. **过渡动画**
   - 所有状态变化使用 `transition: 0.15s ease` 实现平滑过渡

### 3. HomePage 状态管理 (`src/pages/HomePage/index.tsx`)

**改动内容：**
- 将静态的 `mockFolderData` 改为动态的 `useState` 状态
- 实现 `handleFileDrop` 函数处理真正的文件移动
- 支持两种操作：
  - **放入文件夹**：将文件从当前列表移除，添加到目标文件夹
  - **插入排序**：改变文件在列表中的位置
- 自动更新文件夹的 `fileCount` 和 `folderCount` 计数

## 异常处理手法

1. **自身拖拽检测**：不允许将文件拖拽到自身（`dragItem.id === targetItem.id`）
2. **目标类型检测**：放入文件夹操作时验证目标必须是文件夹类型
3. **索引验证**：操作前验证拖拽项和目标项在列表中的存在性
4. **状态深拷贝**：使用 `JSON.parse(JSON.stringify())` 避免直接修改状态
5. **控制台日志**：关键操作输出日志便于调试

## 涉及模块

| 模块路径 | 修改类型 | 说明 |
|---------|---------|------|
| `src/components/FileList/index.tsx` | 重构 | 完全重写，添加拖拽功能 |
| `src/components/FileList/index.module.less` | 重构 | 添加拖拽视觉反馈样式 |
| `src/pages/HomePage/index.tsx` | 修改 | 添加文件数据状态管理和拖拽处理 |

## 可能影响范围

1. **FileList 组件的使用方**：新增了 `onDrop` 回调属性，需要在使用处实现文件移动逻辑
2. **样式变化**：从 Ant Design Table 布局改为自定义 Flex 布局，可能影响现有样式定制
3. **性能**：拖拽过程中会频繁计算位置和更新状态，对于大量文件的场景需要关注性能

## 测试情况

1. **页面加载**：正常加载，无报错
2. **组件渲染**：FileList 组件正常渲染文件列表
3. **拖拽功能**：需要用户在浏览器中手动测试以下场景：
   - 拖拽文件到文件夹上方（中间区域），验证蓝色边框效果
   - 拖拽文件到另一个文件上/下边缘，验证蓝色指示线效果
   - 释放拖拽验证文件是否正确移动/排序
   - 验证两种效果不会同时出现

## 使用说明

### 拖拽操作方式

1. **放入文件夹**：将文件拖拽到目标文件夹的中间区域（距离上下边缘 > 8px），看到蓝色边框高亮后释放
2. **插入排序**：将文件拖拽到目标项的上边缘或下边缘（距离边缘 < 8px），看到蓝色指示线后释放

### 新增 Props

```typescript
interface FileListProps {
  files: FileItem[];
  onFileClick?: (file: FileItem) => void;
  onFolderClick?: (folder: FileItem) => void;
  selectedKeys?: string[];
  onSelectionChange?: (keys: string[]) => void;
  onDrop?: (dragItem: FileItem, targetItem: FileItem | null, position: DropPosition) => void; // 新增
}
```

## 后续优化建议

1. **拖拽预览**：可以添加拖拽时的自定义预览图像
2. **动画优化**：文件移动后可以添加列表重排动画
3. **撤销功能**：可以实现拖拽操作的撤销/重做
4. **跨文件夹拖拽**：当前实现仅支持同一文件夹内的操作，后续可扩展支持跨文件夹
